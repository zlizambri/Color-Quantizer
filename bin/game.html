<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zac's Tap-to-Color Gallery</title>
    <style>
        :root { 
            --bg: #fdfdfd; 
            --card: #ffffff;
            --text: #333;
        }
        
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            overflow-x: hidden;
        }
        
        #header { 
            width: 100%; 
            padding: 15px 0; 
            text-align: center; 
            background: var(--card); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            z-index: 10;
        }

        h1 { font-size: 1.5rem; margin-bottom: 10px; }

        select { 
            padding: 12px; 
            font-size: 16px; 
            border-radius: 10px; 
            border: 1px solid #ddd; 
            width: 85%; 
            max-width: 400px;
            background: #fff;
            -webkit-appearance: none; /* Better iPad styling */
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px 0;
        }

        canvas { 
            border-radius: 12px; 
            background: #fff; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            max-width: 95vw; 
            max-height: 60vh;
            touch-action: none; /* Prevents browser handling touch so the game can */
        }
        
        #palette { 
            display: flex; 
            gap: 12px; 
            padding: 25px; 
            flex-wrap: wrap; 
            justify-content: center; 
            max-width: 500px; 
        }

        .swatch { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: 3px solid #fff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s ease;
            cursor: pointer;
        }

        .swatch.selected { 
            border-color: #333; 
            transform: scale(1.2); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        }

        .hidden { display: none; }
        
        #controls { margin-top: 10px; }
        button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: #4a90e2;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="header">
        <h1>ðŸŽ¨ Tap-to-Color</h1>
        <select id="imageSelector">
            <option value="">-- Choose an Image --</option>
        </select>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" class="hidden"></canvas>
        <div id="palette"></div>
        <div id="controls" class="hidden">
            <button onclick="downloadImage()">Save Masterpiece</button>
        </div>
    </div>

    <script>
        const selector = document.getElementById('imageSelector');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const paletteDiv = document.getElementById('palette');
        const controls = document.getElementById('controls');

        let currentGameData = null;
        let selectedColor = null;
        let userPaintMap = {}; 

        // 1. Fetch the manifest from the folder next to /bin
        // Since this file is in /bin/, we look in ../image_data/
        fetch('../image_data/manifest.json')
            .then(res => {
                if(!res.ok) throw new Error("Manifest not found. Ensure manifest.json is in /image_data/");
                return res.json();
            })
            .then(files => {
                files.forEach(file => {
                    const opt = document.createElement('option');
                    opt.value = file;
                    // Clean up name for the UI (remove _tapdata.json and underscores)
                    opt.textContent = file.replace('_tapdata.json', '').replace(/_/g, ' ');
                    selector.appendChild(opt);
                });
            })
            .catch(err => console.error(err));

        // 2. Load the specific JSON when selected
        selector.onchange = async (e) => {
            if (!e.target.value) return;
            
            try {
                const response = await fetch(`../image_data/${e.target.value}`);
                currentGameData = await response.json();
                setupGame();
            } catch (err) {
                alert("Error loading image data.");
                console.error(err);
            }
        };

        function setupGame() {
            canvas.width = currentGameData.width;
            canvas.height = currentGameData.height;
            canvas.classList.remove('hidden');
            controls.classList.remove('hidden');
            userPaintMap = {};
            selectedColor = null;
            
            // Build the Palette UI
            paletteDiv.innerHTML = '';
            currentGameData.palette.forEach((rgb, idx) => {
                const s = document.createElement('div');
                s.className = 'swatch';
                s.style.backgroundColor = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
                s.onclick = () => {
                    document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
                    s.classList.add('selected');
                    selectedColor = rgb;
                };
                paletteDiv.appendChild(s);
            });
            
            render();
        }

        function render() {
            if (!currentGameData) return;
            const imgData = ctx.createImageData(canvas.width, canvas.height);
            const map = currentGameData.map;

            for (let i = 0; i < map.length; i++) {
                const regionId = map[i];
                // Default: very light grey to act as a "blank" canvas
                let color = userPaintMap[regionId] || [248, 248, 248]; 

                const p = i * 4;
                imgData.data[p] = color[0];
                imgData.data[p+1] = color[1];
                imgData.data[p+2] = color[2];
                imgData.data[p+3] = 255;
            }
            ctx.putImageData(imgData, 0, 0);
        }

        // Handle Taps (Pointer events work best for iPad)
        canvas.addEventListener('pointerdown', (e) => {
            if (!selectedColor || !currentGameData) return;

            const rect = canvas.getBoundingClientRect();
            // Map the screen tap coordinates to the actual pixel coordinates of the image
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            const index = y * canvas.width + x;
            const regionId = currentGameData.map[index];
            
            // If the user tapped a valid region, color it in
            if (regionId !== undefined) {
                userPaintMap[regionId] = selectedColor;
                render();
            }
        });

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'my-painting.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>