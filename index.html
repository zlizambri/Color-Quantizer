<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrismatiCore</title>
    <style>
        body { margin: 0; background: #eee; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #nav { padding: 10px; background: white; text-align: center; border-bottom: 1px solid #ccc; }
        #viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-width: 95%; max-height: 80%; touch-action: none; }
        #palette { display: flex; gap: 10px; padding: 15px; background: white; overflow-x: auto; border-top: 1px solid #ccc; }
        .swatch { min-width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .swatch.selected { border-color: #333; transform: scale(1.1); }
        #status { padding: 5px; text-align: center; background: #fff; font-size: 14px; color: #666; }
    </style>
</head>
<body>

<div id="nav">
    <select id="imageSelector"><option value="">-- Select Image --</option></select>
</div>

<div id="viewport">
    <canvas id="gameCanvas"></canvas>
</div>

<div id="status">Pick a color!</div>
<div id="palette"></div>

<script>
    const selector = document.getElementById('imageSelector');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const paletteDiv = document.getElementById('palette');
    const status = document.getElementById('status');

    let currentGameData = null;
    let selectedColorIdx = null;
    let paintedShapes = new Set();

    // 1. Get List
    fetch('image_data/manifest.json')
        .then(res => res.json())
        .then(data => {
            data.forEach(file => {
                const opt = document.createElement('option');
                opt.value = file;
                opt.textContent = file.replace('_tapdata.json', '');
                selector.appendChild(opt);
            });
        })
        .catch(err => console.error("Manifest error:", err));

    // 2. Load Selection
    selector.onchange = async (e) => {
        if (!e.target.value) return;
        try {
            const res = await fetch(`image_data/${e.target.value}`);
            currentGameData = await res.json();
            paintedShapes.clear();
            selectedColorIdx = null;
            initGame();
        } catch (err) {
            console.error("Load error:", err);
        }
    };

    function initGame() {
        canvas.width = currentGameData.width;
        canvas.height = currentGameData.height;
        
        paletteDiv.innerHTML = '';
        currentGameData.palette.forEach((rgb, idx) => {
            const s = document.createElement('div');
            s.className = 'swatch';
            s.style.backgroundColor = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
            s.onclick = () => {
                document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
                s.classList.add('selected');
                selectedColorIdx = idx + 1;
                draw();
            };
            paletteDiv.appendChild(s);
        });
        draw();
    }

    function draw() {
        if (!currentGameData) return;
        const { width, height, map, shapeToColor, palette } = currentGameData;
        const imgData = ctx.createImageData(width, height);

        for (let i = 0; i < map.length; i++) {
            const id = map[i];
            const colorIdx = shapeToColor[id - 1];
            let r = 248, g = 248, b = 248; // Default Light Gray

            if (id === 0) {
                r = g = b = 255; // Pure white background
            } else if (paintedShapes.has(id)) {
                [r, g, b] = palette[colorIdx - 1];
            } else if (selectedColorIdx === colorIdx) {
                // Hint pattern for the current selected color
                const x = i % width;
                const y = Math.floor(i / width);
                const pattern = (Math.floor(x/10) + Math.floor(y/10)) % 2 === 0;
                r = g = b = pattern ? 255 : 235;
            }

            const p = i * 4;
            imgData.data[p] = r; imgData.data[p+1] = g; imgData.data[p+2] = b; imgData.data[p+3] = 255;
        }
        ctx.putImageData(imgData, 0, 0);
    }

    canvas.addEventListener('pointerdown', (e) => {
        if (!selectedColorIdx || !currentGameData) return;
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
        
        const id = currentGameData.map[y * canvas.width + x];
        if (id > 0 && currentGameData.shapeToColor[id - 1] === selectedColorIdx) {
            paintedShapes.add(id);
            draw();
        }
    });
</script>
</body>
</html>